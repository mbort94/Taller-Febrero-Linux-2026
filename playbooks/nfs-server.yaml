---
- hosts: fileserver
  become: true

  tasks:
    - name: 1. Reinstalar paquetes con dnf
      ansible.builtin.dnf:
        name:
          - nfs-utils
          - rpcbind
        state: present

    - name: 2. Buscar nombres de servicios instalados
      ansible.builtin.shell: "systemctl list-unit-files --type=service | grep -E 'nfs|rpcbind'"
      register: service_list
      changed_when: false

    - name: 3. Mostrar que servicios encontro
      ansible.builtin.debug:
        var: service_list.stdout_lines

    - name: 4. Intentar iniciar nfs-utils de forma gen√©rica
      ansible.builtin.shell: |
        systemctl daemon-reload
        systemctl enable nfs-server
        systemctl start nfs-server
      ignore_errors: yes

    - name: 5. Crear carpeta y configurar exports
      ansible.builtin.file:
        path: /srv/nfs/shared
        state: directory
        mode: '0777'

    - name: 6. Configurar exports
      ansible.builtin.lineinfile:
        path: /etc/exports
        line: "/srv/nfs/shared 192.168.10.0/24(rw,sync,no_root_squash)"
        state: present
      notify: exportar

    - name: 7. Abrir Firewall
      ansible.builtin.shell: |
        firewall-cmd --permanent --add-service=nfs
        firewall-cmd --permanent --add-service=rpc-bind
        firewall-cmd --permanent --add-service=mountd
        firewall-cmd --reload
      ignore_errors: yes

    - name: Abrir puerto 2049 para NFSv4
      ansible.posix.firewalld:
        port: "{{ item }}"
        permanent: yes
        state: enabled
        immediate: yes
      loop:
        - 2049/tcp
        - 2049/udp

  handlers:
    - name: exportar
      ansible.builtin.command: exportfs -ra